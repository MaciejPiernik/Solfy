<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solfy</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --danger:#ef4444; --warn:#eab308;
      --key:#f8fafc; --key-border:#cbd5e1; --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:16px; --rail:#1f2937; --good:#10b981; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0b1026,#0f172a 40%,#0b1026); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}

    .wrap{max-width:960px; margin:0 auto; padding:16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    h1{font-size:20px; margin:0}
    .badge{font-size:12px; color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--rail); background:#0b1226; font-size:12px; color:var(--muted)}
    .pill b{color:var(--ink)}
    .panel{background:var(--card); border:1px solid var(--rail); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px}
    .btn{appearance:none; background:#0b1226; color:var(--ink); border:1px solid var(--rail); padding:10px 12px; border-radius:12px; font-size:14px; cursor:pointer}
    .btn.ghost{background:transparent}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* HOME */
    .home-actions{display:flex; flex-wrap:wrap; gap:8px}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937; padding:8px; font-size:14px; text-align:left}
    th{color:var(--muted); font-weight:600}

    /* CONFIG */
    .grid{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:640px){ .grid{grid-template-columns:repeat(12,1fr)} .span-6{grid-column:span 6} .span-12{grid-column:span 12} }
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:4px}
    select,input[type="number"]{width:100%}

    /* PLAY (no scroll, two halves) */
    .play{position:fixed; inset:0; display:none; height:100vh}
    .play.active{display:grid; grid-template-rows:1fr 1fr; background:linear-gradient(180deg,#0b1026,#0f172a)}
    .play{ --playW: min(920px, 94vw); }

    .top{position:relative; display:flex; align-items:center; justify-content:center; padding:12px}
    .close-btn{position:absolute; top:10px; right:12px; width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:26px; background:#0b1226; border:1px solid var(--rail); color:#fff; box-shadow:var(--shadow)}

    .staff-card{position:relative; background:linear-gradient(180deg,#0c142e,#0a1027); border:1px solid var(--rail); border-radius:var(--radius); box-shadow:var(--shadow); width:var(--playW); height:100%; display:flex; align-items:center; justify-content:center}
    .staff-wrap{position:relative; width:100%; height:100%; padding:12px}
    svg{width:100%; height:100%; display:block}
    .feedback{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    .icon{font-size:72px; line-height:0; opacity:0; transform:scale(.8); transition:opacity .15s ease, transform .15s ease}
    .icon.good{color:var(--accent)}
    .icon.bad{color:var(--danger)}
    .icon.show{opacity:1; transform:scale(1)}

    .bottom{display:grid; grid-template-rows: 1fr auto; gap:8px; padding:12px}
    .piano{position:relative; user-select:none; -webkit-user-select:none; touch-action:manipulation; background:linear-gradient(180deg,#0b1226,#090f20); border:1px solid var(--rail); border-radius:var(--radius); padding:12px; width:var(--playW); height:100%; margin:0 auto; display:flex; align-items:stretch}
    .kb{position:relative; height:100%; width:100%}
    .white-keys{display:grid; grid-template-columns:repeat(7,1fr); height:100%; gap:0; position:relative; z-index:1}
    .white-key{position:relative; background:var(--key); border:1px solid var(--key-border); border-bottom:6px solid #94a3b8; border-radius:0 0 10px 10px; margin:0 2px; cursor:pointer}
    .white-key.correct{background:#d1fae5; border-color:var(--good)}
    .white-key.wrong{background:#fee2e2; border-color:var(--bad)}
    .key-label{position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:12px; color:#334155}
    .black-key{position:absolute; inset:0; pointer-events:none}
    .black{position:absolute; top:0; height:60%; width:calc(100%/7*0.6); background:#0a0f1e; border:1px solid #0b1226; border-bottom:6px solid #0b1226; border-radius:0 0 8px 8px; box-shadow:0 10px 8px rgba(0,0,0,.45); cursor:pointer; z-index:2; pointer-events:auto}
    .black.correct{background:#14532d}
    .black.wrong{background:#7f1d1d}

    .progress{display:flex; align-items:center; gap:8px; width:var(--playW); margin:0 auto}
    .bar{flex:1 1 auto; height:10px; background:#0b1226; border:1px solid var(--rail); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; background:linear-gradient(90deg,#22c55e,#16a34a); width:0%}
    .muted{color:var(--muted)}

    /* Overlay modal */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999; padding:16px}
    .overlay.open{display:flex}
    .sheet{background:var(--card); border:1px solid var(--rail); border-radius:16px; width:min(720px,100%); max-height:90dvh; overflow:auto; padding:16px; box-shadow:var(--shadow)}
    .sheet h2{margin:0 0 8px; font-size:18px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  </style>
</head>
<body>
  <!-- HOME VIEW -->
  <div class="wrap view active" id="viewHome">
    <header>
      <div>
        <h1>Solfy</h1>
        <div class="badge">Piano trainer. Pick a session → play.</div>
      </div>
      <button class="btn" id="goConfig">➕ New session</button>
    </header>

    <section class="panel" id="lastSummary" style="display:none"></section>

    <section class="panel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <h3 style="margin:0">Top sessions</h3>
        <div class="home-actions">
          <button class="btn" id="sortAcc">Best accuracy</button>
          <button class="btn" id="sortTime">Fastest avg time</button>
          <button class="btn ghost" id="clearSessions">Clear history</button>
        </div>
      </div>
      <div id="sessionsTableWrap"></div>
    </section>
  </div>

  <!-- CONFIG VIEW -->
  <div class="wrap view" id="viewConfig">
    <header>
      <div>
        <h1>New session</h1>
        <div class="badge">Choose your settings, then start.</div>
      </div>
      <button class="btn ghost" id="backHome">← Back</button>
    </header>

    <section class="panel">
      <div class="grid">
        <div class="span-6">
          <label for="sessionMode">Mode</label>
          <select id="sessionMode" class="btn">
            <option value="default">Default (20 notes)</option>
            <option value="custom">Custom length…</option>
            <option value="infinite">Infinite</option>
          </select>
        </div>
        <div class="span-6" id="customLenWrap" style="display:none">
          <label for="customLen">Custom session length (notes)</label>
          <input id="customLen" class="btn" type="number" min="1" step="1" value="30" />
        </div>
        <div class="span-6">
          <label for="clef">Clef</label>
          <select id="clef" class="btn"><option value="treble">Treble (𝄞)</option><option value="bass">Bass (𝄢)</option><option value="mixed">Mixed</option></select>
        </div>
        <div class="span-6">
          <label for="range">Range</label>
          <select id="range" class="btn"><option value="within">Within staff</option><option value="extended" selected>Extended</option><option value="ledger">With ledger (±2)</option></select>
        </div>
        <div class="span-6">
          <label for="noteset">Note set / difficulty</label>
          <select id="noteset" class="btn"><option value="naturals" selected>🎯 Naturals only</option><option value="sharps">🎯 Naturals + sharps</option><option value="all">🎯 Naturals + accidentals (♯/♭)</option></select>
        </div>
        <div class="span-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px">
          <button id="startSession" class="btn">Start ▶</button>
        </div>
      </div>
    </section>
  </div>

  <!-- PLAY VIEW (no scroll) -->
  <section class="view play" id="viewPlay" aria-label="game screen">
    <div class="top">
      <div class="staff-card">
        <div class="staff-wrap">
          <svg id="staff" viewBox="0 0 900 300" preserveAspectRatio="xMidYMid meet" aria-label="music staff"></svg>
          <div class="feedback"><div id="fbGood" class="icon good">✔</div><div id="fbBad" class="icon bad" style="margin-left:18px">✖</div></div>
        </div>
      </div>
      <button class="close-btn" id="btnEnd">✕</button>
    </div>

    <div class="bottom">
      <div class="piano">
        <div class="kb" id="keyboard">
          <div class="white-keys" id="whiteKeys"></div>
          <div class="black-key" id="blackKeys"></div>
        </div>
      </div>
      <div class="progress">
        <div class="bar"><span id="barFill"></span></div>
        <div class="muted" id="progressLabel">0 / ∞</div>
      </div>
    </div>
  </section>

  <!-- SUMMARY OVERLAY -->
  <div class="overlay" id="summaryOverlay" aria-modal="true" role="dialog">
    <div class="sheet" id="summarySheet">
      <h2>Session summary</h2>
      <div id="summaryBody"></div>
      <div class="actions">
        <button class="btn ghost" id="sumHome">← Home</button>
        <button class="btn" id="sumAgain">Play again ▶</button>
      </div>
    </div>
  </div>

  <script>
  // ---------- Data & Utilities ----------
  const LETTERS = ['C','D','E','F','G','A','B'];
  const LETTER_TO_INDEX = Object.fromEntries(LETTERS.map((L,i)=>[L,i]));
  const NAT_PC = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
  const SHARP_DISPLAY = {1:'C#',3:'D#',6:'F#',8:'G#',10:'A#'};
  const FLAT_DISPLAY  = {1:'Db',3:'Eb',6:'Gb',8:'Ab',10:'Bb'};
  const ALL_PCS = [0,1,2,3,4,5,6,7,8,9,10,11];
  const NAT_PCS = [0,2,4,5,7,9,11];
  const SHARP_PCS = [1,3,6,8,10];

  const SETTINGS_KEY = 'noteSprintSettings.v3_4';
  const STATS_KEY = 'noteSprintStats.v3_4';
  const PC_STATS_KEY = 'noteSprintPcStats.v3_4';
  const SESSIONS_KEY = 'noteSprintSessions.v3_4';

  function mod(n,m){ return ((n % m) + m) % m; }
  function fmtMs(ms){ if(ms===null || ms===undefined) return '-'; const s = ms/1000; return s<10? s.toFixed(2)+'s' : s.toFixed(1)+'s'; }
  function now(){ return performance.now(); }

  // Staff geometry — gap controls distance between lines; everything else derives from it
  const G = { gap: 28, noteW: 46, noteH: 26, stem: 90, currentTop: 26, currentLeft: 160, currentRight: 740 };
  function syncGlyphSizes(){
    G.noteH = Math.round(G.gap*0.95);
    G.noteW = Math.round(G.noteH*1.55);
    G.stem  = Math.round(G.gap*3.6);
  }
  syncGlyphSizes();

  // Base diatonic indices
  const BASE = { treble: { d0: 4*7 + LETTER_TO_INDEX['E'] }, bass: { d0: 2*7 + LETTER_TO_INDEX['G'] } };
  const RANGES = { treble:{within:[0,8],extended:[-2,10],ledger:[-6,12]}, bass:{within:[0,8],extended:[-2,10],ledger:[-6,12]} };

  function diatonicAtStep(clef, step){ const d = BASE[clef].d0 + step; const letterIndex = mod(d,7); const octave = Math.floor(d/7); return { letter: LETTERS[letterIndex], octave, step }; }
  function accidentalFromName(name){ if(name.includes('#')) return 'sharp'; if(/[b♭]/.test(name)) return 'flat'; return 'n'; }
  function allowedSteps(clef, rangeKey){ const [minS,maxS] = RANGES[clef][rangeKey]; const arr=[]; for(let s=minS;s<=maxS;s++) arr.push(s); return arr; }
  function stepsForLetter(clef, steps, letter){ const idx=LETTER_TO_INDEX[letter]; return steps.filter(s=>LETTER_TO_INDEX[diatonicAtStep(clef,s).letter]===idx); }

  // ---------- State ----------
  const els = {
    // views
    vHome:document.getElementById('viewHome'), vConfig:document.getElementById('viewConfig'), vPlay:document.getElementById('viewPlay'),
    // home
    goConfig:document.getElementById('goConfig'), sortAcc:document.getElementById('sortAcc'), sortTime:document.getElementById('sortTime'), clearSessions:document.getElementById('clearSessions'), sessionsTableWrap:document.getElementById('sessionsTableWrap'), lastSummary:document.getElementById('lastSummary'),
    // config
    backHome:document.getElementById('backHome'), sessionMode:document.getElementById('sessionMode'), customLenWrap:document.getElementById('customLenWrap'), customLen:document.getElementById('customLen'), clef:document.getElementById('clef'), range:document.getElementById('range'), noteset:document.getElementById('noteset'), startSession:document.getElementById('startSession'),
    // play
    svg:document.getElementById('staff'), fbGood:document.getElementById('fbGood'), fbBad:document.getElementById('fbBad'), btnEnd:document.getElementById('btnEnd'), progressLabel:document.getElementById('progressLabel'), barFill:document.getElementById('barFill'), whiteKeys:document.getElementById('whiteKeys'), blackKeys:document.getElementById('blackKeys'), kb:document.getElementById('keyboard'),
    // overlay
    summaryOverlay:document.getElementById('summaryOverlay'), summaryBody:document.getElementById('summaryBody'), sumHome:document.getElementById('sumHome'), sumAgain:document.getElementById('sumAgain')
  };

  const state = {
    settings:{ clef:'treble', range:'extended', noteset:'naturals' },
    stats:{ cards:0, correct:0, mistakes:0, times:[], lastMs:null, streak:0, round:1 },
    card:null, lastCard:null,
    pcStats:{},
    session:{ mode:'infinite', target:null, active:false, startedAt:null, completed:0, id:null },
    sessions:[],
    lastSummary:null
  };

  // ---------- View switching ----------
  function showView(name){
    els.vHome.classList.remove('active');
    els.vConfig.classList.remove('active');
    els.vPlay.classList.remove('active');
    if(name==='home'){ els.vHome.classList.add('active'); document.body.style.overflow='auto'; }
    if(name==='config'){ els.vConfig.classList.add('active'); document.body.style.overflow='auto'; }
    if(name==='play'){ els.vPlay.classList.add('active'); document.body.style.overflow='hidden'; }
  }

  // ---------- Keyboard ----------
  const WHITE_ORDER = ['C','D','E','F','G','A','B'];
  const BLACK_AT = {0:1,1:3,3:6,4:8,5:10};

  function buildKeyboard(){
    els.whiteKeys.innerHTML='';
    els.blackKeys.innerHTML='';
    WHITE_ORDER.forEach((letter)=>{
      const key=document.createElement('div');
      key.className='white-key';
      key.dataset.pc = NAT_PC[letter];
      key.innerHTML=`<div class="key-label">${letter}</div>`;
      key.addEventListener('pointerdown', onKeyPress);
      els.whiteKeys.appendChild(key);
    });
    Object.entries(BLACK_AT).forEach(([whiteIndex,pc])=>{
      const el=document.createElement('div');
      el.className='black';
      el.dataset.pc=pc;
      el.addEventListener('pointerdown', onKeyPress);
      els.blackKeys.appendChild(el);
    });
    positionBlackKeys();
    window.addEventListener('resize', positionBlackKeys);
  }
  function positionBlackKeys(){
    const W=els.kb.getBoundingClientRect().width;
    const keyW=W/7;
    const order=Object.keys(BLACK_AT).map(k=>parseInt(k,10));
    order.forEach((wIndex,idx)=>{
      const bk=els.blackKeys.children[idx];
      const left=(wIndex+1)*keyW - (keyW*0.3);
      bk.style.left=`${left}px`;
      bk.style.width=`${keyW*0.6}px`;
    });
  }

  // ---------- SVG helpers ----------
  function clearSVG(){ els.svg.innerHTML=''; }
  function svgEl(type, attrs){ const el = document.createElementNS('http://www.w3.org/2000/svg', type); for(const k in attrs){ el.setAttribute(k, attrs[k]); } return el; }

  function drawStaff(clef){
    clearSVG();
    // responsive geometry based on actual rendered size
    const vb = els.svg.viewBox.baseVal;
    const px = els.svg.getBoundingClientRect();
    // Scale staff height against card height; clamp
    G.gap = Math.round(Math.max(22, Math.min(54, px.height * 0.11)));
    syncGlyphSizes();

    // Staff length fraction increases as the panel gets narrower (eat internal padding)
    const frac = staffFraction(px.width); // 0.46..0.78
    const width = vb.width, height = vb.height;
    const staffW = width * frac;
    const centerX = width/2;
    const left = centerX - staffW/2;
    const right = centerX + staffW/2;
    G.currentLeft = left; G.currentRight = right;

    // Center the five lines vertically
    G.currentTop = (height - 4*G.gap)/2;
    const top = G.currentTop, gap = G.gap;
    const thk = Math.max(2, Math.round(gap/9));
    for(let i=0;i<5;i++){
      const y = top + i*gap;
      els.svg.appendChild(svgEl('line',{x1:left,y1:y,x2:right,y2:y,stroke:'#cbd5e1','stroke-width':thk,'stroke-linecap':'round'}));
    }
    // Clef sizing & placement tuned per clef
    const clefText = clef==='treble'?'𝄞':'𝄢';
    const clefSize = Math.round(gap*5.2); // slightly larger so loops land on lines
    const clefY = clef==='treble' ? (top + gap*2.65) : (top + gap*2.2);
    const text = svgEl('text',{x:left+26,y:clefY,'font-size': String(clefSize),'text-anchor':'start','dominant-baseline':'middle',fill:'#cbd5e1','font-family':'serif'});
    text.textContent = clefText; els.svg.appendChild(text);
    // Barline
    els.svg.appendChild(svgEl('line',{x1:left-8,y1:top-8,x2:left-8,y2:top+gap*4+8,stroke:'#94a3b8','stroke-width':Math.max(2,thk-1),'stroke-linecap':'round'}));
  }
  function staffFraction(pxWidth){
    const min=360, max=920; // when narrow, use more horizontal room
    const t = Math.max(0, Math.min(1, (max - pxWidth)/(max - min)));
    return 0.46 + t*(0.78 - 0.46);
  }
  function yForStep(step){ const bottomY = G.currentTop + 4*G.gap; return bottomY - step*(G.gap/2); }

  function drawLedgerLines(step, x){
    const half = (G.noteW*1.8)/2;
    const thk = Math.max(2, Math.round(G.gap/9));
    if(step < 0){
      const count=Math.floor((-step)/2);
      for(let i=1;i<=count;i++){
        const k=-2*i; const y=yForStep(k);
        els.svg.appendChild(svgEl('line',{x1:x-half,y1:y,x2:x+half,y2:y,stroke:'#cbd5e1','stroke-width':thk,'stroke-linecap':'round'}));
      }
    }
    if(step > 8){
      const count=Math.floor((step-8)/2);
      for(let i=1;i<=count;i++){
        const k=8+2*i; const y=yForStep(k);
        els.svg.appendChild(svgEl('line',{x1:x-half,y1:y,x2:x+half,y2:y,stroke:'#cbd5e1','stroke-width':thk,'stroke-linecap':'round'}));
      }
    }
  }

  function drawNote(step, accidental='n'){
    const x = (G.currentLeft + G.currentRight)/2;
    const y = yForStep(step);
    drawLedgerLines(step, x);
    // note head
    const head = svgEl('ellipse',{cx:x,cy:y,rx:G.noteW/2,ry:G.noteH/2,fill:'#e5e7eb'});
    head.setAttribute('transform',`rotate(-20 ${x} ${y})`);
    els.svg.appendChild(head);
    // stem
    const up = step <= 4;
    const stemX = up ? x + (G.noteW/2) - 2 : x - (G.noteW/2) + 2;
    const stemY2 = up ? y - G.stem : y + G.stem;
    els.svg.appendChild(svgEl('line',{x1:stemX,y1:y,x2:stemX,y2:stemY2,stroke:'#e5e7eb','stroke-width':Math.max(2, Math.round(G.gap/9)),'stroke-linecap':'round'}));
    // accidental sized to staff
    if(accidental!=='n'){
      const accSize = Math.round(G.gap*2.6);
      const txt = svgEl('text',{x:x-54,y:y+6,'font-size': String(accSize),'text-anchor':'middle','dominant-baseline':'middle',fill:'#e5e7eb'});
      txt.textContent = accidental==='sharp'?'♯':'♭';
      els.svg.appendChild(txt);
    }
  }

  // ---------- Adaptive weighting ----------
  function loadPcStats(){ try{ state.pcStats = JSON.parse(localStorage.getItem(PC_STATS_KEY)||'{}') || {}; }catch(e){ state.pcStats={}; } }
  function savePcStats(){ localStorage.setItem(PC_STATS_KEY, JSON.stringify(state.pcStats)); }
  function touchPc(pc){ if(!state.pcStats[pc]) state.pcStats[pc] = {attempts:0, wrongs:0, avgTime:null}; }
  function recordPc(pc, correct, time){ touchPc(pc); const s=state.pcStats[pc]; s.attempts += 1; if(!correct) s.wrongs += 1; if(time!=null){ if(s.avgTime==null) s.avgTime=time; else s.avgTime = s.avgTime*0.8 + time*0.2; } savePcStats(); }
  function pcWeight(pc){ touchPc(pc); const s=state.pcStats[pc]; const err = s.attempts? s.wrongs/s.attempts : 0; const tf = s.avgTime? Math.min(2, s.avgTime/3000) : 0; return 1 + 2*err + tf + 0.05; }
  function pickPcWeighted(pcs, notPc){ const weights = pcs.map(pc=>pcWeight(pc)); let total=weights.reduce((a,b)=>a+b,0); let guard=0; while(guard++<50){ let r=Math.random()*total; for(let i=0;i<pcs.length;i++){ r-=weights[i]; if(r<=0){ const cand=pcs[i]; if(cand!==notPc) return cand; break; } } } let p = pcs[Math.floor(Math.random()*pcs.length)]; if(p===notPc) p = pcs[(pcs.indexOf(p)+1)%pcs.length]; return p; }

  // ---------- Cards ----------
  function pcPool(mode){ if(mode==='naturals') return NAT_PCS; if(mode==='sharps') return NAT_PCS.concat(SHARP_PCS); return ALL_PCS; }

  function nextCard(){
    const set=state.settings;
    const clef = set.clef==='mixed' ? (Math.random()<0.5?'treble':'bass') : set.clef;
    drawStaff(clef);
    const steps=allowedSteps(clef,set.range);
    const pcs=pcPool(set.noteset);
    let pc, letterName, accidental, stepCandidates=[]; let guard=0;
    do{
      guard++; if(guard>100){ break; }
      pc = pickPcWeighted(pcs, state.lastCard? state.lastCard.pc : null);
      if(NAT_PCS.includes(pc)) letterName = Object.entries(NAT_PC).find(([L,v])=>v===pc)[0];
      else if(set.noteset==='sharps') letterName = SHARP_DISPLAY[pc];
      else letterName = Math.random()<0.5 ? SHARP_DISPLAY[pc] : FLAT_DISPLAY[pc];
      accidental = accidentalFromName(letterName);
      const baseLetter = letterName[0];
      stepCandidates = stepsForLetter(clef, steps, baseLetter);
    } while(stepCandidates.length===0 || (state.lastCard && state.lastCard.pc===pc && state.lastCard.step===stepCandidates[0]));

    const step = stepCandidates[Math.floor(Math.random()*stepCandidates.length)];
    const di = diatonicAtStep(clef, step);
    state.card = { clef, step, letter:di.letter, accidental, pc, startedAt:now(), solved:false };
    drawNote(step, accidental);
    hideFeedback();
    highlightKey(null,'clear');
  }

  // ---------- Interaction ----------
  function showGood(){ els.fbGood.classList.add('show'); els.fbBad.classList.remove('show'); }
  function showBad(){ els.fbBad.classList.add('show'); setTimeout(()=>els.fbBad.classList.remove('show'), 250); }
  function hideFeedback(){ els.fbGood.classList.remove('show'); els.fbBad.classList.remove('show'); }

  function onKeyPress(ev){
    ev.preventDefault();
    const pc=parseInt(ev.currentTarget.dataset.pc,10);
    if(!state.card || state.card.solved) return;
    if(pc===state.card.pc){
      const t=now()-state.card.startedAt;
      state.card.solved=true;
      recordAttempt(true, t);
      highlightKey(pc,'good');
      showGood();
      state.lastCard = { pc: state.card.pc, step: state.card.step };
      setTimeout(nextCard, 600);
    } else {
      state.stats.mistakes += 1;
      recordPc(state.card.pc, false, null);
      showBad();
      highlightKey(pc,'bad');
      state.stats.streak=0;
      persistStats();
    }
  }

  function highlightKey(pc, mode){ const whites=[...els.whiteKeys.children], blacks=[...els.blackKeys.children], all=whites.concat(blacks); if(mode==='clear'){ all.forEach(k=>k.classList.remove('correct','wrong')); return; } all.forEach(k=>{ const is=parseInt(k.dataset.pc,10)===pc; k.classList.toggle(mode==='good'?'correct':'wrong', is); if(!is && mode!=='reveal'){ k.classList.remove('correct','wrong'); } }); }

  // ---------- Stats ----------
  function recordAttempt(correct, timeOrNull){ if(correct){ state.stats.correct += 1; state.stats.streak += 1; if(timeOrNull!=null){ state.stats.lastMs=timeOrNull; state.stats.times.push(timeOrNull); } concludeCard(); recordPc(state.card.pc, true, timeOrNull); } persistStats(); }
  function concludeCard(){ state.stats.cards += 1; state.session.completed += 1; updateProgress(); maybeEndSession(); }
  function accuracy(){ const denom = state.stats.correct + state.stats.mistakes; return denom? Math.round((state.stats.correct/denom)*100) : 0; }
  function avgTime(){ if(!state.stats.times.length) return null; return state.stats.times.reduce((a,b)=>a+b,0)/state.stats.times.length; }

  // ---------- Persistence ----------
  function persistSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings)); }
  function loadSettings(){ try{ const j=JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}'); if(j) Object.assign(state.settings, j); }catch(e){} }
  function persistStats(){ localStorage.setItem(STATS_KEY, JSON.stringify(state.stats)); }
  function loadStats(){ try{ const j=JSON.parse(localStorage.getItem(STATS_KEY)||'{}'); if(j && typeof j==='object'){ Object.assign(state.stats, j); } }catch(e){} }
  function loadSessions(){ try{ state.sessions = JSON.parse(localStorage.getItem(SESSIONS_KEY)||'[]'); if(!Array.isArray(state.sessions)) state.sessions=[]; }catch(e){ state.sessions=[]; } }
  function saveSessions(){ localStorage.setItem(SESSIONS_KEY, JSON.stringify(state.sessions)); }

  // ---------- Sessions ----------
  function startSession(mode, target){ state.session = { mode, target: (mode==='custom'||mode==='default')? target:null, active:true, startedAt:Date.now(), completed:0, id: 'sess_'+Date.now() }; resetStats(true); updateProgress(); showView('play'); nextCard(); }
  function endSession(reason){ if(!state.session.active) return; state.session.active=false; const s = summarizeSession(reason||'ended'); state.sessions.push(s); saveSessions(); state.lastSummary = s; renderSummary(); renderSessions(); showSummaryOverlay(s); }
  function summarizeSession(reason){ return { id: state.session.id, when: new Date().toISOString(), mode: state.session.mode, target: state.session.target, completed: state.session.completed, correct: state.stats.correct, mistakes: state.stats.mistakes, accuracy: accuracy(), avgTime: avgTime(), totalTime: elapsedSince(state.session.startedAt), settings: {...state.settings}, reason }; }
  function elapsedSince(ts){ return Date.now()-ts; }
  function maybeEndSession(){ if(!state.session.active) return; if(state.session.mode==='default' || state.session.mode==='custom'){ const N = state.session.mode==='default'? 20 : (state.session.target||0); if(state.session.completed>=N){ endSession('completed'); } } }
  function updateProgress(){ const N = state.session.mode==='default'? 20 : (state.session.mode==='custom'? (state.session.target||0) : Infinity); const c = state.session.completed; els.progressLabel.textContent = (N===Infinity)? `${c} / ∞` : `${c} / ${N}`; els.barFill.style.width = (N===Infinity? 0 : Math.min(100, (c/N)*100)) + '%'; }
  function resetStats(keepRound){ state.stats = { cards:0, correct:0, mistakes:0, times:[], lastMs:null, streak:0, round: keepRound? state.stats.round : state.stats.round+1 }; persistStats(); }

  // ---------- Home (sessions table & summary) ----------
  function renderSessions(sortBy){ const list = state.sessions.slice(); const by = sortBy||'acc'; if(by==='acc') list.sort((a,b)=> b.accuracy - a.accuracy || (a.avgTime??1e9) - (b.avgTime??1e9)); else list.sort((a,b)=> (a.avgTime??1e9) - (b.avgTime??1e9) || b.accuracy - a.accuracy); const rows = list.slice(0,20).map(s=>`<tr><td>${new Date(s.when).toLocaleString()}</td><td>${s.mode}${s.mode!=='infinite'?` (${s.target})`:''}</td><td>${s.completed}</td><td>${s.correct}</td><td>${s.mistakes}</td><td>${s.accuracy}%</td><td>${s.avgTime?fmtMs(s.avgTime):'-'}</td><td>${fmtMs(s.totalTime)}</td></tr>`).join(''); els.sessionsTableWrap.innerHTML = `<table><thead><tr><th>Date</th><th>Mode</th><th>Cards</th><th>Correct</th><th>Mistakes</th><th>Accuracy</th><th>Avg time</th><th>Total</th></tr></thead><tbody>${rows||'<tr><td colspan="8" class="muted">No sessions yet.</td></tr>'}</tbody></table>`; }
  function renderSummary(){ if(!state.lastSummary){ els.lastSummary.style.display='none'; return; } const s=state.lastSummary; els.lastSummary.style.display='block'; els.lastSummary.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between"><div><strong>Last session:</strong> ${new Date(s.when).toLocaleString()} — ${s.mode}${s.mode!=='infinite'?` (${s.target})`:''}</div><div class="pill">Accuracy <b>${s.accuracy}%</b> • Avg ${s.avgTime?fmtMs(s.avgTime):'-'} • Cards ${s.completed}</div></div>`; }

  // ---------- Summary overlay ----------
  function showSummaryOverlay(s){ const html = `
      <div class="grid2">
        <div><div class="muted">Cards</div><div style="font-size:20px">${s.completed}</div></div>
        <div><div class="muted">Accuracy</div><div style="font-size:20px">${s.accuracy}%</div></div>
        <div><div class="muted">Correct</div><div style="font-size:20px">${s.correct}</div></div>
        <div><div class="muted">Mistakes</div><div style="font-size:20px">${s.mistakes}</div></div>
        <div><div class="muted">Avg time</div><div style="font-size:20px">${s.avgTime?fmtMs(s.avgTime):'-'}</div></div>
        <div><div class="muted">Total time</div><div style="font-size:20px">${fmtMs(s.totalTime)}</div></div>
      </div>
      <div class="pill" style="margin-top:8px">${s.mode}${s.mode!=='infinite'?` • ${s.target} notes`:''}</div>`;
    els.summaryBody.innerHTML = html; els.summaryOverlay.classList.add('open'); }
  function hideSummaryOverlay(){ els.summaryOverlay.classList.remove('open'); }

  // ---------- Init & events ----------
  function applySettingsToUI(){ els.clef.value=state.settings.clef; els.range.value=state.settings.range; els.noteset.value=state.settings.noteset; }
  function onSettingsChanged(){ state.settings.clef=els.clef.value; state.settings.range=els.range.value; state.settings.noteset=els.noteset.value; persistSettings(); }

  function init(){
    loadSettings(); loadSessions(); loadStats(); loadPcStats();
    applySettingsToUI(); buildKeyboard(); renderSessions(); renderSummary();
    // home
    els.goConfig.addEventListener('click', ()=>showView('config'));
    els.sortAcc.addEventListener('click', ()=>renderSessions('acc'));
    els.sortTime.addEventListener('click', ()=>renderSessions('time'));
    els.clearSessions.addEventListener('click', ()=>{ if(confirm('Clear all stored sessions?')){ state.sessions=[]; saveSessions(); renderSessions(); } });
    // config
    els.backHome.addEventListener('click', ()=>showView('home'));
    els.sessionMode.addEventListener('change', ()=>{ els.customLenWrap.style.display = (els.sessionMode.value==='custom')? 'block' : 'none'; });
    els.clef.addEventListener('change', onSettingsChanged); els.range.addEventListener('change', onSettingsChanged); els.noteset.addEventListener('change', onSettingsChanged);
    els.startSession.addEventListener('click', ()=>{ const mode=els.sessionMode.value; const target = mode==='custom'? Math.max(1, parseInt(els.customLen.value||'30',10)) : (mode==='default'?20:null); startSession(mode, target); });
    // play
    els.btnEnd.addEventListener('click', ()=>endSession('ended'));
    // overlay
    els.sumHome.addEventListener('click', ()=>{ hideSummaryOverlay(); showView('home'); });
    els.sumAgain.addEventListener('click', ()=>{ const m = state.lastSummary? state.lastSummary.mode : 'default'; const t = state.lastSummary? state.lastSummary.target : 20; hideSummaryOverlay(); startSession(m, t); });
    // start on home
    showView('home');
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
